<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERKI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=20260204_Restored">
    <link rel="stylesheet" href="pro_dashboard.css?v=20260205_CardStyles">
    <style>
        .delete-member-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .delete-member-btn:hover {
            background: #fef2f2;
            color: #ef4444;
        }

        .grid-2-custom {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .grid-2-custom {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="no-motion.css?v=20260204_RestoredTable">
    <link rel="icon" type="image/png" href="logo.png">
</head>

<body>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <a href="index.html" class="logo">
            <img src="merki_logo_transparent.png" alt="MERKI Logo" class="logo-img">MERKI
        </a>
        <button class="mobile-menu-btn" id="mobile-toggle">
            <span></span>
            <span></span>
            <span></span>
        </button>
    </header>

    <div class="dashboard-layout">
        <!-- CRM-style Sidebar -->
        <aside class="sidebar" id="sidebar">
            <a href="#" class="logo" style="pointer-events: none; cursor: default;">
                <span>MERKI管理</span>
            </a>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-section="dashboard" onclick="showSection('dashboard')">
                    <span class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <rect width="7" height="9" x="3" y="3" rx="1" />
                            <rect width="7" height="5" x="14" y="3" rx="1" />
                            <rect width="7" height="9" x="14" y="12" rx="1" />
                            <rect width="7" height="5" x="3" y="16" rx="1" />
                        </svg>
                    </span>
                    <span>ダッシュボード</span>
                </a>
                <a href="#" class="nav-item" data-section="regulations" onclick="showSection('regulations')">
                    <span class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                            <path d="M12 11h4" />
                            <path d="M12 16h4" />
                            <path d="M8 11h.01" />
                            <path d="M8 16h.01" />
                        </svg>
                    </span>
                    <span>制度一覧</span>
                </a>
                <a href="#" class="nav-item" data-section="team" onclick="showSection('team')">
                    <span class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                    </span>
                    <span>チーム管理</span>
                </a>
                <a href="#" class="nav-item" data-section="profile" onclick="showSection('profile')">
                    <span class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path
                                d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                            <circle cx="12" cy="12" r="3" />
                        </svg>
                    </span>
                    <span>プロフィール設定</span>
                </a>
                <a href="#" class="nav-item" data-section="subscription" onclick="showSection('subscription')">
                    <span class="nav-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <rect width="20" height="14" x="2" y="5" rx="2" />
                            <line x1="2" x2="22" y1="10" y2="10" />
                        </svg>
                    </span>
                    <span>プラン・お支払い</span>
                </a>

                <div style="padding: 1rem 0.75rem; border-top: 1px solid var(--border-color); margin-top: auto;">
                    <a href="#" id="logout-btn-side" class="nav-item logout-btn">
                        <span class="nav-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                                <polyline points="16 17 21 12 16 7" />
                                <line x1="21" x2="9" y1="12" y2="12" />
                            </svg>
                        </span>
                        <span>ログアウト</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-inner">

                <!-- Section: Dashboard -->
                <div id="section-dashboard" class="content-section active">
                    <!-- Stats Grid -->
                    <div class="grid-2-custom" style="margin-bottom: 3rem;">
                        <div class="stat-card">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
                                <span class="stat-icon-wrapper"
                                    style="background: rgba(102, 126, 234, 0.1); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">
                                    <span style="font-size:1.2rem;">📋</span>
                                </span>
                                <div class="stat-label" style="font-size: 1rem; margin-bottom: 0;">該当制度</div>
                            </div>
                            <div class="stat-value" id="total-regulations">0</div>
                        </div>
                        <div class="stat-card">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
                                <span class="stat-icon-wrapper"
                                    style="background: rgba(245, 158, 11, 0.1); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px;">
                                    <span style="font-size:1.2rem;">🔔</span>
                                </span>
                                <div class="stat-label" style="font-size: 1rem; margin-bottom: 0;">30日内の期限</div>
                            </div>
                            <div class="stat-value" id="upcoming-count">0</div>
                        </div>
                    </div>

                    <!-- Upcoming Deadlines -->
                    <div id="upcoming-section" class="glass-card" style="margin-bottom: 3rem;">
                        <h2
                            style="margin-bottom: 2rem; font-size: 1.75rem; font-weight: 800; color: var(--text-primary);">
                            📅 直近の期限</h2>
                        <div id="upcoming-deadlines">
                            <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">制度を計算中...</p>
                        </div>
                    </div>

                </div>

                <!-- Section: Regulations List (New) -->
                <div id="section-regulations" class="content-section">

                    <div class="glass-card fade-in-up">
                        <div id="all-regulations" style="overflow-x: auto;">
                            <!-- 税務カテゴリ -->
                            <div class="category-accordion" id="cat-tax">
                                <div class="category-header" onclick="toggleCategory('tax')">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2rem;">🏛️</span>
                                        <span style="font-weight: 800; color: var(--text-primary);">税務</span>
                                        <span class="badge"
                                            style="background: #f1f5f9; color: #64748b; margin-left: 8px; text-transform: none; padding: 0.25rem 0.75rem;">8件</span>
                                    </div>
                                    <span class="accordion-icon">▼</span>
                                </div>
                                <div class="category-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>制度名</th>
                                                <th>期限</th>
                                                <th>残日数</th>
                                                <th style="text-align:center;">通知</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 700;">法人税申告</td>
                                                <td>決算月+2ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('corporate_tax', '法人税申告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">消費税申告</td>
                                                <td>決算月+2ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('consumption_tax', '消費税申告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">源泉所得税納付</td>
                                                <td>毎月10日</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('withholding_tax', '源泉所得税納付')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">年末調整</td>
                                                <td>毎年12月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('year_end_adjustment', '年末調整')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">固定資産税申告</td>
                                                <td>毎年1月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('fixed_asset_tax', '固定資産税申告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">法人税中間申告</td>
                                                <td>決算月+8ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('corporate_interim_tax', '法人税中間申告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">消費税中間申告</td>
                                                <td>決算月+8ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('consumption_interim_tax', '消費税中間申告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">法人住民税・事業税</td>
                                                <td>決算月+2ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('resident_tax', '法人住民税・事業税')">編集</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- 労務カテゴリ -->
                            <div class="category-accordion" id="cat-labor">
                                <div class="category-header" onclick="toggleCategory('labor')">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2rem;">👥</span>
                                        <span style="font-weight: 800; color: var(--text-primary);">労務</span>
                                        <span class="badge"
                                            style="background: #f1f5f9; color: #64748b; margin-left: 8px; text-transform: none; padding: 0.25rem 0.75rem;">6件</span>
                                    </div>
                                    <span class="accordion-icon">▼</span>
                                </div>
                                <div class="category-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>制度名</th>
                                                <th>期限</th>
                                                <th>残日数</th>
                                                <th style="text-align:center;">通知</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 700;">労働保険 年度更新</td>
                                                <td>毎年6月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('labor_insurance', '労働保険 年度更新')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">算定基礎届</td>
                                                <td>毎年7月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('pension_report', '算定基礎届')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">定期健康診断</td>
                                                <td>毎年9月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('health_checkup', '定期健康診断')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">ストレスチェック</td>
                                                <td>毎年11月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('stress_check', 'ストレスチェック')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">社会保険料納付</td>
                                                <td>毎月末日</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('social_insurance', '社会保険料納付')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">36協定届出</td>
                                                <td>毎年3月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('labor_agreement', '36協定届出')">編集</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- その他カテゴリ -->
                            <div class="category-accordion" id="cat-other">
                                <div class="category-header" onclick="toggleCategory('other')">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.2rem;">📄</span>
                                        <span style="font-weight: 800; color: var(--text-primary);">その他</span>
                                        <span class="badge"
                                            style="background: #f1f5f9; color: #64748b; margin-left: 8px; text-transform: none; padding: 0.25rem 0.75rem;">10件</span>
                                    </div>
                                    <span class="accordion-icon">▼</span>
                                </div>
                                <div class="category-content">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>制度名</th>
                                                <th>期限</th>
                                                <th>残日数</th>
                                                <th style="text-align:center;">通知</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="font-weight: 700;">決算公告</td>
                                                <td>決算月+3ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('financial_disclosure', '決算公告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">法定調書合計表</td>
                                                <td>毎年1月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('legal_report', '法定調書合計表')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">源泉徴収票交付</td>
                                                <td>毎年1月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('withholding_slip', '源泉徴収票交付')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">住民税特別徴収</td>
                                                <td>毎月10日</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('resident_tax_collect', '住民税特別徴収')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">事業所税申告</td>
                                                <td>決算月+2ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('office_tax', '事業所税申告')">編集</button></td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">事業報告書提出</td>
                                                <td>決算月+3ヶ月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('business_report', '事業報告書提出')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">賞与支払届</td>
                                                <td>支払後5日以内</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('bonus_report', '賞与支払届')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">雇用保険料申告</td>
                                                <td>毎年6月</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('employment_insurance', '雇用保険料申告')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">法人登記事項変更届</td>
                                                <td>変更後2週間以内</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('registration_change', '法人登記事項変更届')">編集</button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-weight: 700;">法人番号変更届</td>
                                                <td>速やかに</td>
                                                <td>-</td>
                                                <td style="text-align:center;"><label class="switch"><input
                                                            type="checkbox" checked><span class="slider"></span></label>
                                                </td>
                                                <td><button class="edit-btn"
                                                        onclick="openEditModal('corporate_number_change', '法人番号変更届')">編集</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section: Team (New) -->
                <div id="section-team" class="content-section">
                    <div class="glass-card fade-in-up">
                        <div id="team-status-header"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="margin: 0;">チームメンバー管理</h3>
                            <span id="team-limit-badge" class="badge"
                                style="background: #e2e8f0; color: #475569;">取得中...</span>
                        </div>
                        <div id="team-list">
                            <!-- Helper function will render this -->
                        </div>
                    </div>
                </div>

                <!-- Add Member Modal -->
                <div id="add-member-modal" class="modal-overlay" style="display: none; z-index: 10000;">
                    <div class="modal-content" style="max-width: 500px;">
                        <button class="close-modal-pro" id="close-add-member-x">&times;</button>
                        <h2
                            style="font-size: 1.5rem; font-weight: 800; margin-bottom: 2rem; color: var(--text-primary); padding-right: 3rem;">
                            チームメンバーを招待
                        </h2>
                        <form id="invite-member-form">
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">メールアドレス</label>
                                <input type="email" id="invite-email" required class="input-pro"
                                    placeholder="member@example.com">
                            </div>
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">権限</label>
                                <select id="invite-role" class="input-pro">
                                    <option value="admin">管理者 (全機能の利用)</option>
                                    <option value="editor">編集者 (設定変更のみ)</option>
                                    <option value="viewer">閲覧者 (閲覧のみ)</option>
                                </select>
                            </div>
                            <button type="submit" class="btn primary-btn"
                                style="width: 100%; padding: 1rem; margin-top: 1rem;">招待メールを送信</button>
                        </form>
                    </div>
                </div>

                <!-- Section: Profile -->
                <div id="section-profile" class="content-section">

                    <div class="glass-card no-hover" style="max-width: 1100px;">
                        <form id="profile-form">
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">🏢 会社名・屋号</label>
                                <input type="text" id="company-name" required class="input-pro"
                                    placeholder="株式会社○○ / ○○事務所">
                            </div>
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">🏢 会社種別</label>
                                <select id="company-type" required class="input-pro">
                                    <option value="">選択してください</option>
                                    <option value="corporation">法人</option>
                                    <option value="sole">個人事業主</option>
                                </select>
                            </div>
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">🏢 業種</label>
                                <select id="industry" required class="input-pro">
                                    <option value="">選択してください</option>
                                    <option value="it">IT・通信</option>
                                    <option value="ec">EC・小売</option>
                                    <option value="food">飲食業</option>
                                    <option value="other">その他</option>
                                </select>
                            </div>
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">👥 従業員数</label>
                                <select id="employee-size" required class="input-pro">
                                    <option value="">選択してください</option>
                                    <option value="1">1名（代表のみ）</option>
                                    <option value="2-5">2〜5名</option>
                                    <option value="6-20">6〜20名</option>
                                </select>
                            </div>
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">📅 決算月</label>
                                <select id="fiscal-month" required class="input-pro">
                                    <option value="">選択してください</option>
                                    <option value="1">1月</option>
                                    <option value="2">2月</option>
                                    <option value="3">3月</option>
                                    <option value="4">4月</option>
                                    <option value="5">5月</option>
                                    <option value="6">6月</option>
                                    <option value="7">7月</option>
                                    <option value="8">8月</option>
                                    <option value="9">9月</option>
                                    <option value="10">10月</option>
                                    <option value="11">11月</option>
                                    <option value="12">12月</option>
                                </select>
                            </div>
                            <div class="form-group-pro">
                                <label class="label-pro-fixed">📅 設立年月日</label>
                                <input type="text" id="incorporation-date" required class="input-pro"
                                    placeholder="2024/01/01">
                            </div>
                            <button type="submit" class="btn primary-btn"
                                style="width: 100%; padding: 1.25rem; font-size: 1.1rem;">💾 変更を保存する</button>
                        </form>
                    </div>
                </div>

                <!-- Section: Subscription -->
                <div id="section-subscription" class="content-section" style="max-width: 1100px; margin: 0 auto;">
                    <div class="membership-dashboard fade-in-up">
                        <!-- Single Membership Card -->
                        <div class="membership-card">
                            <div class="membership-card-watermark">MERKI</div>

                            <!-- Top Branding -->
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; z-index: 2; width: 100%;">
                                <h2 class="gold-text-metallic"
                                    style="font-family: 'OCR A Std', 'Courier New', monospace; letter-spacing: 6px; font-size: 1.8rem; margin: 0; line-height: 1;">
                                    MERKI</h2>
                                <div class="membership-badge"
                                    style="position: static; border: 1.5px solid var(--card-border); color: var(--card-border); padding: 0.5rem 1.4rem; border-radius: 4px; font-size: 0.85rem; font-weight: 800; letter-spacing: 2px; background: rgba(0,0,0,0.6); box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
                                    PRO</div>
                            </div>

                            <!-- Main Content Grid -->
                            <div class="membership-status-grid" style="z-index: 2;">
                                <div class="status-main">
                                    <div class="card-dates">
                                        <div>
                                            <div class="card-label">MEMBER SINCE</div>
                                            <div class="card-value">01/26</div>
                                        </div>
                                        <div>
                                            <div class="card-label">VALID THRU</div>
                                            <div class="card-value">02/26</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="card-label">CARD MEMBER</div>
                                        <div class="card-value card-member-name">VIP MEMBER</div>
                                    </div>
                                </div>

                                <div class="status-visual">
                                    <div class="progress-indicator-wrapper">
                                        <div class="progress-ring-bg"></div>
                                        <svg viewBox="0 0 140 140" class="progress-ring-svg">
                                            <circle cx="70" cy="70" r="62"
                                                style="fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 4;">
                                            </circle>
                                            <circle cx="70" cy="70" r="62"
                                                style="fill: none; stroke: var(--card-border); stroke-width: 10; stroke-linecap: round; stroke-dasharray: 390; stroke-dashoffset: 65; filter: drop-shadow(0 0 8px var(--card-accent-glow)); transition: stroke-dashoffset 2s ease-out;">
                                            </circle>
                                        </svg>
                                        <div class="progress-text">
                                            <span class="progress-label">残り</span>
                                            <span class="progress-number">29</span>
                                            <span class="progress-unit">日</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Benefits Section -->
                        <div class="benefits-section">
                            <h3><span style="font-size: 1.5rem;">✨</span> 解放されているプレミアム機能</h3>
                            <div class="benefits-grid">
                                <div class="benefit-item">
                                    <div class="benefit-icon">🔔</div>
                                    <div class="benefit-info">
                                        <h4>各制度の期限通知</h4>
                                        <p>30日、7日、前日のタイミングで自動リマインドを送信します。</p>
                                    </div>
                                </div>
                                <div class="benefit-item">
                                    <div class="benefit-icon">👥</div>
                                    <div class="benefit-info">
                                        <h4>チーム管理機能</h4>
                                        <p>最大10名のメンバーを招待し、管理画面を共有できます。</p>
                                    </div>
                                </div>
                                <div class="benefit-item">
                                    <div class="benefit-icon">⚙️</div>
                                    <div class="benefit-info">
                                        <h4>通知内容のカスタマイズ</h4>
                                        <p>通知されるメッセージの文面を制度ごとに自由に変更可能です。</p>
                                    </div>
                                </div>
                                <div class="benefit-item">
                                    <div class="benefit-icon">✅</div>
                                    <div class="benefit-info">
                                        <h4>個別通知のON/OFF</h4>
                                        <p>ご自身の状況に合わせ、制度ごとに通知の有無を制御できます。</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Button -->
                        <div style="display: flex; justify-content: center; margin-bottom: 3rem;">
                            <div id="paypal-button-container" style="width: 100%; max-width: 500px;">
                                <a href="pricing.html" class="btn primary-btn"
                                    style="width: 100%; padding: 1.25rem; font-size: 1.1rem; border-radius: 12px; display: block; text-align: center; text-decoration: none;">有料プランにアップグレード</a>
                            </div>
                        </div>

                        <div class="payment-security">
                            <div class="security-badge">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                                </svg>
                                PayPalによる安全な決済
                            </div>
                            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 1rem;">
                                お支払いはPayPal経由で安全に処理されます。クレジットカード情報は本サービスには保存されません。
                            </p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Notification Edit Modal -->
    <div id="edit-modal" class="modal-overlay" style="display: none; z-index: 10000;">
        <div class="modal-content edit-modal-content" style="max-width: 500px;">
            <button class="close-modal-pro" id="close-modal-x">&times;</button>
            <h2
                style="font-size: 1.25rem; font-weight: 900; margin-bottom: 1rem; color: var(--text-primary); padding-right: 3rem;">
                📊 通知メールの編集
            </h2>

            <!-- 対象制度 -->
            <div class="form-group-pro" style="margin-bottom: 1rem;">
                <label class="label-pro-fixed" style="font-size: 0.75rem;">対象制度</label>
                <p id="edit-reg-title"
                    style="font-weight: 800; color: var(--text-primary); font-size: 1.1rem; margin: 0;"></p>
            </div>

            <!-- タブ切り替え -->
            <div class="notification-tabs" style="display: flex; gap: 0; margin-bottom: 1rem;">
                <button type="button" class="notification-tab active" data-days="30"
                    style="padding: 0.5rem 1rem; background: none; border: none; border-bottom: 2px solid #6366f1; color: #6366f1; font-weight: 700; cursor: pointer; font-size: 0.9rem;">30日前</button>
                <button type="button" class="notification-tab" data-days="7"
                    style="padding: 0.5rem 1rem; background: none; border: none; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: 600; cursor: pointer; font-size: 0.9rem;">7日前</button>
                <button type="button" class="notification-tab" data-days="1"
                    style="padding: 0.5rem 1rem; background: none; border: none; border-bottom: 2px solid transparent; color: #94a3b8; font-weight: 600; cursor: pointer; font-size: 0.9rem;">前日</button>
            </div>

            <!-- 通知メッセージ -->
            <div class="form-group-pro" style="margin-bottom: 1rem;">
                <label class="label-pro-fixed"
                    style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #6366f1;">
                    📧 通知メッセージ <span
                        style="font-weight: 400; font-size: 0.75rem; color: var(--text-secondary);">（この内容がそのままメールで届きます）</span>
                </label>
                <p
                    style="font-size: 0.8rem; color: #f59e0b; margin-bottom: 0.75rem; display: flex; align-items: flex-start; gap: 0.4rem; line-height: 1.5;">
                    <span>💡</span> <span>自分用のメモ・税理士への転送文面・社内共有用の注意書きなど、自由にカスタマイズできます</span>
                </p>
                <textarea id="edit-custom-message" class="textarea-pro" style="height: 220px; resize: none;"></textarea>
            </div>

            <div class="btn-group-pro" style="justify-content: flex-end;">
                <button type="button" class="btn primary-btn" id="save-edit-btn"
                    style="flex: 0 1 150px; padding: 0.875rem 1.5rem;">保存する</button>
            </div>
        </div>
    </div>

    <!-- Navigation Script (non-module for immediate availability) -->
    <script>
        // --- SPA Section Logic ---
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(function (s) { s.classList.remove('active'); });
            var section = document.getElementById('section-' + sectionId);
            if (section) section.classList.add('active');

            document.querySelectorAll('.nav-item').forEach(function (n) { n.classList.remove('active'); });
            var activeNav = document.querySelector('.nav-item[data-section="' + sectionId + '"]');
            if (activeNav) activeNav.classList.add('active');

            // Close mobile sidebar if open
            var sidebar = document.getElementById('sidebar');
            if (sidebar) sidebar.classList.remove('active');

            var mobileToggle = document.getElementById('mobile-toggle');
            if (mobileToggle) mobileToggle.classList.remove('active');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Category Accordion Toggle ---
        function toggleCategory(key) {
            var el = document.getElementById('cat-' + key);
            if (el) el.classList.toggle('active');
        }

        // --- Default Email Templates ---
        // 編集可能な部分: note（補足説明）のみ
        // intro（導入文）は変数を含むため固定
        const DEFAULT_TEMPLATES = {
            30: {
                subject: '【MERKI】{{regulationName}}の期限まで、あと30日です',
                intro: '{{regulationName}}の期限が、約30日後に近づいています。',
                note: `現時点で対応いただく必要はありませんが、
この時期に一度ご確認いただくことで、
今後の予定が立てやすくなります。

必要な対応がある場合は、
ご自身のタイミングでご準備ください。`
            },
            7: {
                subject: '【MERKI】{{regulationName}}の期限まで、あと7日です',
                intro: '{{regulationName}}の期限が、1週間後に迫っています。',
                note: `対応が必要な制度の場合は、
このタイミングで準備状況をご確認ください。

期限直前にも、あらためてお知らせいたします。`
            },
            1: {
                subject: '【MERKI】{{regulationName}}の期限は明日です',
                intro: '{{regulationName}}の期限は、明日となっています。',
                note: `すでに対応済みの場合は、
本メールは読み流していただいて問題ありません。

未対応の場合は、
お時間の許す範囲でご確認ください。`
            }
        };

        // Current editing state
        window.currentEditingId = null;
        window.currentEditingDays = 30;
        window.editingTemplates = {};

        // --- Modal Logic ---
        function openEditModal(id, title) {
            document.getElementById('edit-reg-title').textContent = title;
            document.getElementById('edit-modal').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // 背景スクロール無効化
            window.currentEditingId = id;
            window.currentEditingDays = 30;

            // Load saved templates or use defaults
            window.editingTemplates = {};
            [30, 7, 1].forEach(days => {
                let savedNote = null;
                // Check Global User Data first (Firestore)
                if (window.currentUserData && window.currentUserData.custom_templates && window.currentUserData.custom_templates[id] && window.currentUserData.custom_templates[id][days]) {
                    savedNote = window.currentUserData.custom_templates[id][days].note;
                }
                // Fallback to LocalStorage (Legacy) - Optional: Remove if fully migrating
                if (!savedNote) {
                    savedNote = localStorage.getItem(`template_${id}_${days}_note`);
                }

                window.editingTemplates[days] = {
                    note: savedNote !== null ? savedNote : DEFAULT_TEMPLATES[days].note
                };
            });

            // Reset tabs
            document.querySelectorAll('.notification-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = '#94a3b8';
            });
            const activeTab = document.querySelector('.notification-tab[data-days="30"]');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = '#6366f1';
                activeTab.style.color = '#6366f1';
            }

            // Load 30-day template
            loadTemplateForDays(30);
        }

        function loadTemplateForDays(days) {
            const textarea = document.getElementById('edit-custom-message');
            if (textarea) {
                const template = window.editingTemplates[days];
                textarea.value = template.note;
            }
        }

        function saveCurrentTemplate() {
            const days = window.currentEditingDays;
            const textarea = document.getElementById('edit-custom-message');
            if (textarea) {
                window.editingTemplates[days] = {
                    note: textarea.value
                };
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- Mobile Toggle Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            var mobileToggle = document.getElementById('mobile-toggle');
            var sidebar = document.getElementById('sidebar');
            if (mobileToggle && sidebar) {
                mobileToggle.onclick = function (e) {
                    e.stopPropagation();
                    mobileToggle.classList.toggle('active');
                    sidebar.classList.toggle('active');
                };

                document.addEventListener('click', function (e) {
                    var isMobile = window.innerWidth <= 1024;
                    if (isMobile && sidebar.classList.contains('active') &&
                        !sidebar.contains(e.target) &&
                        !mobileToggle.contains(e.target)) {
                        sidebar.classList.remove('active');
                        mobileToggle.classList.remove('active');
                    }
                });
            }

            // --- Team Member Modal Logic ---
            var addMemberBtn = document.getElementById('add-member-btn');
            var addMemberModal = document.getElementById('add-member-modal');
            var closeAddMemberX = document.getElementById('close-add-member-x');

            if (addMemberBtn && addMemberModal) {
                addMemberBtn.onclick = function () {
                    addMemberModal.style.display = 'flex';
                };
            }
            if (closeAddMemberX && addMemberModal) {
                closeAddMemberX.onclick = function () {
                    addMemberModal.style.display = 'none';
                };
            }

            // --- Edit Modal Logic ---
            var editModal = document.getElementById('edit-modal');
            var closeModalX = document.getElementById('close-modal-x');
            var saveEditBtn = document.getElementById('save-edit-btn');

            function closeEditModal() {
                if (editModal) editModal.style.display = 'none';
                document.body.style.overflow = ''; // 背景スクロール復元
            }

            if (closeModalX) closeModalX.onclick = closeEditModal;

            // Tab switching
            document.querySelectorAll('.notification-tab').forEach(tab => {
                tab.onclick = function () {
                    // Save current before switching
                    saveCurrentTemplate();

                    // Update tab styles
                    document.querySelectorAll('.notification-tab').forEach(t => {
                        t.classList.remove('active');
                        t.style.borderBottomColor = 'transparent';
                        t.style.color = '#94a3b8';
                    });
                    this.classList.add('active');
                    this.style.borderBottomColor = '#6366f1';
                    this.style.color = '#6366f1';

                    // Load new template
                    const days = parseInt(this.dataset.days);
                    window.currentEditingDays = days;
                    loadTemplateForDays(days);
                };
            });

            // Save all templates
            if (saveEditBtn) {
                saveEditBtn.onclick = function () {
                    // Save current tab first
                    saveCurrentTemplate();

                    if (window.saveTemplateToFirestore) {
                        saveEditBtn.disabled = true;
                        saveEditBtn.textContent = '保存中...';
                        const id = window.currentEditingId;
                        const dataToSave = {};
                        [30, 7, 1].forEach(days => {
                            dataToSave[days] = window.editingTemplates[days];
                        });

                        window.saveTemplateToFirestore(id, dataToSave)
                            .then(() => {
                                alert('保存しました');
                                closeEditModal();
                            })
                            .catch((err) => {
                                alert('保存エラー: ' + err.message);
                            })
                            .finally(() => {
                                saveEditBtn.disabled = false;
                                saveEditBtn.textContent = '保存';
                            });
                    } else {
                        // Fallback
                        alert('保存機能が読み込まれていません。リロードしてください。');
                    }

                };
            }
        });
    </script>

    <script type="module">
        import { auth, db, onAuthStateChanged } from './js/firebase-config.js?v=20260203_final_v13';
        import { doc, getDoc, setDoc, getDocs, collection, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { checkInvitation, showWelcomeNotification } from './js/auth.js?v=20260203_final_v13';
        import { COMPLIANCE_ITEMS, getApplicableCompliances, calculateDeadline } from './js/compliance-logic.js?v=20260203_final_v13';

        let currentUserData = null;
        let PAYPAL_CLIENT_ID = 'sb';
        let PAYPAL_PLAN_IDS = {
            pro: 'P-PRO-TEST',
            standard: 'P-STANDARD-TEST',
            lite: 'P-LITE-TEST'
        };
        // Mock deletion tracker (Persistent)
        window.mockDeletedIds = JSON.parse(localStorage.getItem('mockDeletedIds') || '[]');

        // --- Auth & Data Loading ---
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // If not logged in, redirect to index with current search params (invitation info)
                window.location.href = 'index.html' + window.location.search;
                return;
            }

            // Check for invitations and join team if needed
            await checkInvitation(user);

            // Fetch PayPal Config
            try {
                const configResponse = await fetch('/.netlify/functions/get-paypal-config');
                const config = await configResponse.json();
                PAYPAL_CLIENT_ID = config.clientId;
                PAYPAL_PLAN_IDS = {
                    pro: config.planIdPro,
                    standard: config.planIdStandard,
                    lite: config.planIdLite
                };
            } catch (e) {
                console.error("PayPal config load failed:", e);
            }

            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();

                    window.currentUserData = currentUserData; // Expose global
                    if (!currentUserData.company_type) {
                        showSection('profile');
                    }
                    updateDashboardUI(currentUserData);
                    fillProfileForm(currentUserData);
                    loadSubscriptionUI(currentUserData, user);
                } else {
                    showSection('profile');
                }
            } catch (error) {
                console.error("Data load error:", error);
            }
        });

        // --- Global Save Function ---
        window.saveTemplateToFirestore = async (regulationId, templatesData) => {
            const user = auth.currentUser;
            if (!user) throw new Error("Not logged in");

            const updateData = {};
            // dot notation for nested update: custom_templates.REG_ID = { 30: {...}, 7: {...} }
            updateData[`custom_templates.${regulationId}`] = templatesData;

            await setDoc(doc(db, 'users', user.uid), updateData, { merge: true });

            // Update local cache immediately
            if (!window.currentUserData.custom_templates) window.currentUserData.custom_templates = {};
            window.currentUserData.custom_templates[regulationId] = templatesData;
        };


        // --- Dashboard Logic ---
        function updateDashboardUI(userData) {
            try { renderCompliances(userData); } catch (e) { console.error("Compliances Error:", e); }
            try { renderTeamSection(userData); } catch (e) { console.error("Team Error:", e); }
        }

        async function renderCompliances(userData) {
            const upcomingEl = document.getElementById('upcoming-deadlines');
            const allEl = document.getElementById('all-regulations');
            const totalEl = document.getElementById('total-regulations');
            const upcomingCountEl = document.getElementById('upcoming-count');

            const applicableItems = getApplicableCompliances(userData);
            if (applicableItems.length === 0) {
                upcomingEl.innerHTML = '<p style="text-align: center; padding: 2rem;">該当する制度がありません</p>';
                allEl.innerHTML = '<p style="text-align: center; padding: 2rem;">該当する制度がありません</p>';
                return;
            }

            const deadlines = applicableItems.map(item => {
                const deadline = calculateDeadline(item, userData);
                const daysUntil = Math.ceil((deadline - new Date()) / (1000 * 60 * 60 * 24));
                return { ...item, deadline, daysUntil };
            }).sort((a, b) => a.deadline - b.deadline);

            totalEl.textContent = deadlines.length;
            upcomingCountEl.textContent = deadlines.filter(d => d.daysUntil <= 30 && d.daysUntil >= 0).length;

            // Render Upcoming (Top 3)
            upcomingEl.innerHTML = deadlines.slice(0, 3).map(item => {
                const color = item.daysUntil <= 7 ? '#ef4444' : item.daysUntil <= 30 ? '#f59e0b' : '#3b82f6';
                return `<div class="glass-card" style="margin-bottom: 1rem; padding: 1.5rem;">
                    <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--text-primary);">${item.title}</h3>
                    <div style="display: flex; gap: 1rem; font-size: 0.85rem; font-weight: 700;">
                        <span>📅 ${item.deadline.toLocaleDateString('ja-JP')}</span>
                        <span style="color: ${color}">${item.daysUntil}日後</span>
                    </div>
                </div>`;
            }).join('');

            // Grouping by category
            const groups = {
                tax: { title: '税務', icon: '🏛️', items: [] },
                labor: { title: '労務', icon: '👥', items: [] },
                other: { title: 'その他', icon: '📄', items: [] }
            };

            deadlines.forEach(item => {
                const cat = item.category || 'other';
                if (groups[cat]) groups[cat].items.push(item);
                else groups['other'].items.push(item);
            });

            // Render Grouped Accordion
            let html = '';
            for (const [key, group] of Object.entries(groups)) {
                if (group.items.length === 0) continue;

                html += `
                    <div class="category-accordion" id="cat-${key}">
                        <div class="category-header" onclick="toggleCategory('${key}')">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.2rem;">${group.icon}</span>
                                <span style="font-weight: 800; color: var(--text-primary);">${group.title}</span>
                                <span class="badge" style="background: #f1f5f9; color: #64748b; margin-left: 8px; text-transform: none; padding: 0.25rem 0.75rem;">${group.items.length}件</span>
                            </div>
                            <span class="accordion-icon">▼</span>
                        </div>
                        <div class="category-content">
                            <table>
                                <thead>
                                    <tr><th>制度名</th><th>期限</th><th>残日数</th><th style="text-align:center;">通知</th><th>操作</th></tr>
                                </thead>
                                <tbody>
                                    ${group.items.map(item => `
                                        <tr onclick="if(window.innerWidth<=1024) this.classList.toggle('expanded')">
                                            <td style="font-weight: 700;">${item.title}</td>
                                            <td>${item.deadline.toLocaleDateString('ja-JP')}</td>
                                            <td>${item.daysUntil}日</td>
                                            <td style="text-align:center;" onclick="event.stopPropagation()">
                                                <label class="switch">
                                                    <input type="checkbox" checked>
                                                    <span class="slider"></span>
                                                </label>
                                            </td>
                                            <td onclick="event.stopPropagation()">
                                                <button class="edit-btn" onclick="openEditModal('${item.id}', '${item.title}')">編集</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            allEl.innerHTML = html;
        }

        // --- Profile Logic ---
        function fillProfileForm(userData) {
            document.getElementById('company-name').value = userData.company_name || '';
            document.getElementById('company-type').value = userData.company_type || '';
            document.getElementById('industry').value = userData.industry || '';
            document.getElementById('employee-size').value = userData.employee_size || '';
            document.getElementById('fiscal-month').value = userData.fiscal_month || '';
            if (userData.incorporation_date) {
                const d = userData.incorporation_date.toDate();
                document.getElementById('incorporation-date').value = `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
            }
        }

        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '保存中...';

            try {
                const user = auth.currentUser;
                const incDateValue = document.getElementById('incorporation-date').value;

                // Validate Date (Simple check)
                let incDate = new Date();
                if (incDateValue) {
                    // Try parsing "YYYY/MM/DD" or "YYYY-MM-DD"
                    const cleanDate = incDateValue.replace(/\//g, '-');
                    const parsed = new Date(cleanDate);
                    if (!isNaN(parsed.getTime())) {
                        incDate = parsed;
                    } else {
                        throw new Error("設立年月日の形式が正しくありません (例: 2024/01/01)");
                    }
                }

                await setDoc(doc(db, 'users', user.uid), {
                    company_name: document.getElementById('company-name').value,
                    company_type: document.getElementById('company-type').value,
                    industry: document.getElementById('industry').value,
                    employee_size: document.getElementById('employee-size').value,
                    fiscal_month: parseInt(document.getElementById('fiscal-month').value),
                    incorporation_date: incDate,
                    updated_at: serverTimestamp()
                }, { merge: true });

                // Update local state without reload
                if (!currentUserData) currentUserData = {};
                currentUserData.company_name = document.getElementById('company-name').value;
                currentUserData.company_type = document.getElementById('company-type').value;
                currentUserData.industry = document.getElementById('industry').value;
                currentUserData.employee_size = document.getElementById('employee-size').value;
                currentUserData.fiscal_month = parseInt(document.getElementById('fiscal-month').value);
                currentUserData.incorporation_date = { toDate: () => incDate };

                updateDashboardUI(currentUserData); // Re-calculate deadlines based on new profile

                alert('プロフィールを保存しました。');

                // Navigate to home section or reload to refresh full state
                // Assuming 'home' is the default section or reloading to trigger logic
                // showSection('home'); // This might not exist based on snippet
                // Reload is safer to ensure all "Profile Check" logic passes
                window.location.reload();

            } catch (error) {
                console.error("Profile Save Error:", error);
                alert('保存エラー: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };

        // --- Subscription Logic ---
        async function loadSubscriptionUI(userData, user) {
            const container = document.getElementById('section-subscription');
            const status = userData.subscription_status || 'trial';

            // Calculate trial days (assumes 30 days from updated_at if trial)
            let trialDaysLeft = 30;
            if (userData.updated_at) {
                const updatedDate = userData.updated_at.toDate();
                const now = new Date();
                const diffTime = now - updatedDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                trialDaysLeft = Math.max(0, 30 - diffDays);
            }

            const regDate = userData.created_at ? userData.created_at.toDate() : (userData.updated_at ? userData.updated_at.toDate() : new Date());
            const expDate = new Date(regDate);
            expDate.setDate(expDate.getDate() + 30);
            const memberSince = (regDate.getMonth() + 1).toString().padStart(2, '0') + '/' + regDate.getFullYear().toString().slice(-2);
            const validThru = (expDate.getMonth() + 1).toString().padStart(2, '0') + '/' + expDate.getFullYear().toString().slice(-2);

            // Determine card theme based on plan
            let plan = userData.plan || 'pro'; // 'lite', 'standard', 'pro' - default to pro for trial users

            // Auto-Downgrade Logic: Determine Effective Plan
            // If trial expired, treat as 'lite'
            if (status === 'trial' && trialDaysLeft <= 0) {
                plan = 'lite';
            }

            const cardThemeClass = plan === 'pro' ? '' : plan; // pro uses default (no class), others use .lite or .standard
            const planBadgeText = plan === 'pro' ? 'PRO' : (plan === 'standard' ? 'STANDARD' : 'LITE');
            const isProPlan = plan === 'pro';
            const showTrialInfo = isProPlan && status === 'trial'; // PROプランかつトライアル中のみ残り日数表示

            container.innerHTML = `
                <div class="membership-dashboard">
                    <div class="membership-card ${cardThemeClass}">
                        <div class="membership-card-watermark">MERKI</div>

                        <!-- Top Branding -->
                        <div class="card-header-row">
                            <h2 class="gold-text-metallic card-logo-text">MERKI</h2>
                            <div class="plan-badge-responsive">${planBadgeText}</div>
                        </div>

                        <!-- Main Content Grid -->
                        <div class="membership-status-grid" style="z-index: 2;">
                            <div class="status-main">
                                ${showTrialInfo ? `
                                <div class="card-dates">
                                    <div>
                                        <div class="card-label">MEMBER SINCE</div>
                                        <div class="card-value">${memberSince}</div>
                                    </div>
                                    <div>
                                        <div class="card-label">VALID THRU</div>
                                        <div class="card-value">${validThru}</div>
                                    </div>
                                </div>
                                ` : ''}

                                <div>
                                    <div class="card-label">MERKI MEMBER</div>
                                    <div class="card-value card-member-name">${userData.company_name || 'VIP MEMBER'}</div>
                                </div>
                            </div>

                            ${showTrialInfo ? `
                            <div class="status-visual">
                                <div class="progress-indicator-wrapper">
                                    <div class="progress-ring-bg"></div>
                                    <svg viewBox="0 0 140 140" class="progress-ring-svg">
                                        <circle cx="70" cy="70" r="62" style="fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 4;"></circle>
                                        <circle cx="70" cy="70" r="62" style="fill: none; stroke: var(--card-border); stroke-width: 10; stroke-linecap: round; stroke-dasharray: 390; stroke-dashoffset: ${390 * (1 - trialDaysLeft / 30)}; filter: drop-shadow(0 0 8px var(--card-accent-glow)); transition: stroke-dashoffset 2s ease-out;"></circle>
                                    </svg>
                                    <div class="progress-text">
                                        <span class="progress-label">残り</span>
                                        <span class="progress-number">${trialDaysLeft}</span>
                                        <span class="progress-unit">日</span>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="benefits-section">
                        <h3><span style="font-size: 1.5rem;">✨</span> 解放されているプレミアム機能</h3>
                        <div class="benefits-grid">
                            <div class="benefit-item">
                                <div class="benefit-icon">🔔</div>
                                <div class="benefit-info">
                                    <h4>各制度の期限通知</h4>
                                    <p>30日、7日、前日のタイミングで自動リマインドを送信します。</p>
                                </div>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">👥</div>
                                <div class="benefit-info">
                                    <h4>チーム管理機能</h4>
                                    <p>最大10名のメンバーを招待し、管理画面を共有できます。</p>
                                </div>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">⚙️</div>
                                <div class="benefit-info">
                                    <h4>通知内容のカスタマイズ</h4>
                                    <p>通知されるメッセージの文面を制度ごとに自由に変更可能です。</p>
                                </div>
                            </div>
                            <div class="benefit-item">
                                <div class="benefit-icon">✅</div>
                                <div class="benefit-info">
                                    <h4>個別通知のON/OFF</h4>
                                    <p>ご自身の状況に合わせ、制度ごとに通知の有無を制御できます。</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: center; margin-bottom: 3rem;">
                        <div id="paypal-button-container" style="width: 100%; max-width: 500px;"></div>
                    </div>

                    <div class="payment-security">
                        <div class="security-badge">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                            PayPalによる安全な決済
                        </div>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 1rem;">
                            お支払いはPayPal経由で安全に処理されます。クレジットカード情報は本サービスには保存されません。
                        </p>
                    </div>

                    <!-- Cancel Subscription Section -->
                    <div id="cancel-subscription-section" style="display: none; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <h3 style="font-size: 1rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 1rem;">サブスクリプション管理</h3>
                        <button id="cancel-subscription-btn" class="btn" style="width: 100%; max-width: 400px; padding: 1rem; background: transparent; color: #ef4444; border: 2px solid #ef4444; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                            サブスクリプションを解約する
                        </button>
                        <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.75rem;">
                            解約しても現在の請求期間終了まではサービスをご利用いただけます。
                        </p>
                    </div>
                </div >
                `;

            // Show cancel button for active or trial users
            if (status === 'active' || status === 'trial') {
                setTimeout(() => {
                    const cancelSection = document.getElementById('cancel-subscription-section');
                    const cancelBtn = document.getElementById('cancel-subscription-btn');
                    if (cancelSection) {
                        cancelSection.style.display = 'block';
                    }
                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', () => handleCancelSubscription(userData, user));
                        cancelBtn.addEventListener('mouseenter', () => {
                            cancelBtn.style.background = '#ef4444';
                            cancelBtn.style.color = '#fff';
                        });
                        cancelBtn.addEventListener('mouseleave', () => {
                            cancelBtn.style.background = 'transparent';
                            cancelBtn.style.color = '#ef4444';
                        });
                    }
                }, 100);
            }

            if (status === 'trial') {
                loadPayPalSDK(() => renderPayPalButton('paypal-button-container', PAYPAL_PLAN_IDS.pro, 'pro', user));
            }

            // Show Resubscribe Options for Cancelled Users
            if (status === 'cancelled') {
                const container = document.getElementById('cancel-subscription-section'); // Reuse or create new
                const resubscribeHtml = `
                    <div id="resubscribe-section" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border-color); width: 100%; max-width: 1100px; margin-left: auto; margin-right: auto;">
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <h3 style="font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 1rem;">プランの再開・変更</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                サブスクリプションは現在停止中です。<br>
                                再度MERKIの機能を利用するには、プランを選択してください。
                            </p>
                            <a href="pricing.html" target="_blank" style="color: #6366f1; text-decoration: underline; font-weight: 600;">➡ 各プランの詳細・機能比較はこちら（料金ページ）</a>
                        </div>

                        <div class="pricing-grid">
                            <!-- Pro Plan -->
                            <div class="pricing-card recommended" style="margin-top:0;">
                                <div class="plan-badge">推奨プラン</div>
                                <h3 class="plan-name">Pro</h3>
                                <div class="price">¥4,980<small>/月</small></div>
                                <p class="plan-description"><span>覚えておくことから、</span><span>解放されたい方に</span></p>
                                <div id="paypal-resubscribe-container-pro" style="margin-top: auto; padding-top: 2rem;"></div>
                            </div>

                            <!-- Standard Plan -->
                            <div class="pricing-card">
                                <h3 class="plan-name">Standard</h3>
                                <div class="price">¥1,980<small>/月</small></div>
                                <p class="plan-description"><span>税理士・担当者と、</span><span>安心して共有したい方に</span></p>
                                <div id="paypal-resubscribe-container-standard" style="margin-top: auto; padding-top: 2rem;"></div>
                            </div>

                            <!-- Lite Plan -->
                            <div class="pricing-card">
                                <h3 class="plan-name">Lite</h3>
                                <div class="price">¥980<small>/月</small></div>
                                <p class="plan-description"><span>前日に知らせてくれれば</span><br><span>十分、という方に</span></p>
                                <div id="paypal-resubscribe-container-lite" style="margin-top: auto; padding-top: 2rem;"></div>
                            </div>
                        </div>
                    </div>
                 `;

                // Append to section-subscription
                const subSection = document.getElementById('section-subscription');
                // Create valid HTML element
                const div = document.createElement('div');
                div.innerHTML = resubscribeHtml;
                subSection.querySelector('.membership-dashboard').appendChild(div);

                // Render PayPal Buttons immediately
                loadPayPalSDK(() => {
                    renderPayPalButton('paypal-resubscribe-container-pro', PAYPAL_PLAN_IDS.pro, 'pro', user);
                    renderPayPalButton('paypal-resubscribe-container-standard', PAYPAL_PLAN_IDS.standard, 'standard', user);
                    renderPayPalButton('paypal-resubscribe-container-lite', PAYPAL_PLAN_IDS.lite, 'lite', user);
                });
            }
        }

        // Handle subscription cancellation
        async function handleCancelSubscription(userData, user) {
            const confirmed = confirm('本当にサブスクリプションを解約しますか？\n\n解約しても現在の請求期間終了まではサービスをご利用いただけます。');
            if (!confirmed) return;

            const cancelBtn = document.getElementById('cancel-subscription-btn');
            if (cancelBtn) {
                cancelBtn.disabled = true;
                cancelBtn.textContent = '処理中...';
            }

            try {
                // Special handling for trial users (no subscription_id)
                if (userData.subscription_status === 'trial' || !userData.subscription_id) {
                    // Update DB directly for trial cancellation
                    await setDoc(doc(db, 'users', user.uid), {
                        subscription_status: 'cancelled',
                        canceled_at: serverTimestamp(),
                        updated_at: serverTimestamp()
                    }, { merge: true });

                    alert('トライアル期間中の解約を受け付けました。\nサービスは期間終了までご利用いただけます。');
                    location.reload();
                    return;
                }

                const response = await fetch('/.netlify/functions/cancel-subscription', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscriptionId: userData.subscription_id })
                });

                const result = await response.json();

                if (result.success) {
                    alert('サブスクリプションを解約しました。現在の請求期間終了まではサービスをご利用いただけます。');
                    location.reload();
                } else {
                    throw new Error(result.error || '解約に失敗しました');
                }
            } catch (error) {
                console.error('Cancel error:', error);
                alert('解約処理でエラーが発生しました: ' + error.message);
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.textContent = 'サブスクリプションを解約する';
                }
            }
        }

        function loadPayPalSDK(callback) {
            if (window.paypal) return callback();
            const s = document.createElement('script');
            s.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&vault=true&intent=subscription`;
            s.onload = callback;
            document.head.appendChild(s);
        }

        function renderPayPalButton(containerId, planId, planName, user) {
            const container = document.getElementById(containerId);
            if (!container) return;

            paypal.Buttons({
                style: { shape: 'rect', color: 'blue', layout: 'vertical', label: 'subscribe' },
                createSubscription: (data, actions) => actions.subscription.create({
                    'plan_id': planId,
                    'custom_id': user.uid,
                    'subscriber': { 'email_address': user.email }
                }),
                onApprove: async (data, actions) => {
                    await setDoc(doc(db, 'users', user.uid), {
                        subscription_id: data.subscriptionID,
                        subscription_status: 'active',
                        subscription_plan: planName,
                        plan: planName, // redundancy
                        subscription_start_date: new Date(),
                        updated_at: serverTimestamp()
                    }, { merge: true });
                    alert(planName.toUpperCase() + 'プランの契約が完了しました！');
                    location.reload();
                },
                onError: (err) => {
                    console.error('PayPal Error:', err);
                    alert('エラーが発生しました。しばらくしてから再度お試しください。');
                }
            }).render('#' + containerId);
        }

        // --- Modal Logic ---
        // --- Modal Logic ---
        const closeEditModal = () => {
            const m = document.getElementById('edit-modal');
            if (m) m.style.display = 'none';
        };

        const closeModalX = document.getElementById('close-modal-x');
        if (closeModalX) closeModalX.onclick = closeEditModal;

        const closeEditBtn = document.getElementById('close-edit-modal');
        if (closeEditBtn) closeEditBtn.onclick = closeEditModal;

        // --- Team Logic ---
        async function renderTeamSection(userData) {
            const teamListEl = document.getElementById('team-list');
            const limitBadgeEl = document.getElementById('team-limit-badge');
            const user = auth.currentUser;

            // Define Limits
            const PLAN_LIMITS = { 'lite': 1, 'standard': 3, 'pro': 5 };
            let userPlan = userData.plan || 'lite';

            // Trial Override: Always treat as Pro during 30-day trial
            if (userData.subscription_status === 'trial') {
                // Calculate trial days (assumes 30 days from updated_at if trial)
                let trialDaysLeft = 30;
                if (userData.updated_at) {
                    const updatedDate = userData.updated_at.toDate();
                    const now = new Date();
                    const diffTime = now - updatedDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    trialDaysLeft = Math.max(0, 30 - diffDays);
                }

                if (trialDaysLeft > 0) {
                    userPlan = 'pro';
                } else {
                    userPlan = 'lite';
                }
            }

            const maxMembers = PLAN_LIMITS[userPlan] || 1;

            const isOwner = userData.owner_uid === undefined || userData.owner_uid === user.uid;
            const isAdmin = userData.role === 'admin';

            if (teamListEl) {
                teamListEl.innerHTML = '<p style="text-align:center; padding:2rem; color:#94a3b8;">読み込み中...</p>';
            }

            try {
                // 1. Fetch Active Members (users with owner_uid == current uid)
                const membersQ = query(collection(db, 'users'), where('owner_uid', '==', user.uid));
                const membersSnap = await getDocs(membersQ);

                // 2. Fetch Pending Invitations
                const invitesQ = query(collection(db, 'invitations'), where('owner_uid', '==', user.uid));
                const invitesSnap = await getDocs(invitesQ);

                // Count logic: Owner (1) + Members (excluding self if queried) + Invites
                // FIX: Filter out locally deleted IDs from the count!
                let currentCount = 1; // Start with Owner
                membersSnap.forEach(doc => {
                    if (doc.id !== user.uid && !window.mockDeletedIds.includes(doc.id)) {
                        currentCount++;
                    }
                });

                let inviteCount = 0;
                invitesSnap.forEach(doc => {
                    if (!window.mockDeletedIds.includes(doc.id)) {
                        inviteCount++;
                    }
                });
                currentCount += inviteCount;

                const remainingSlots = Math.max(0, maxMembers - currentCount);
                const percent = Math.min(100, (currentCount / maxMembers) * 100);

                // Update Header Badge
                if (limitBadgeEl) {
                    limitBadgeEl.textContent = `${currentCount}/${maxMembers}名`;
                    limitBadgeEl.className = currentCount > maxMembers ? 'badge badge-danger' : 'badge badge-info'; // Warning if over
                    limitBadgeEl.style.background = currentCount > maxMembers ? '#fef2f2' : '#f0f9ff';
                    limitBadgeEl.style.color = currentCount > maxMembers ? '#ef4444' : '#0ea5e9';
                }

                let html = '';

                // Plan Limit Visual
                const planName = userPlan === 'lite' ? 'ライトプラン' : userPlan === 'standard' ? 'スタンダード' : 'プロ';
                const planLabel = userData.subscription_status === 'trial' ? `${planName}（無料トライアル）` : planName;

                html += `
                    <div style="margin-bottom: 2rem;">
                        <div class="plan-limit-info">
                            <span>利用状況（${planLabel}）</span>
                            <span>${remainingSlots === 0 ? '追加枠なし' : 'あと' + remainingSlots + '名追加可能'}</span>
                        </div>
                        <div class="plan-limit-bar">
                            <div class="plan-limit-progress" style="width: ${percent}%; ${currentCount > maxMembers ? 'background: #ef4444;' : ''}"></div>
                        </div>
                    </div>
                `;

                // Owner Card (Always Visible)
                const ownerName = userData.contact_name || userData.company_name || 'あなた';
                html += `
                    <div class="team-member-item">
                        <div class="team-member-info">
                            <div class="member-avatar" style="background: var(--primary-gradient); color: white;">主</div>
                            <div class="member-details">
                                <span class="member-name">${ownerName}（オーナー）</span>
                                <span class="member-role">全権限</span>
                            </div>
                        </div>
                        <div class="member-status-badge" style="background: #3b82f6; color: white;">アクティブ</div>
                    </div>
                `;

                // Render Active Members
                membersSnap.forEach(docSnap => {
                    const m = docSnap.data();
                    if (docSnap.id === user.uid) return; // Skip owner if already rendered
                    if (window.mockDeletedIds.includes(docSnap.id)) return; // Skip locally deleted

                    const name = m.contact_name || m.email;
                    const roleLabel = m.role === 'admin' ? '管理者' : m.role === 'editor' ? '編集者' : '閲覧者';

                    // Only show delete button for owners or admins (and admins can't delete owners)
                    const canDelete = isOwner || (isAdmin && m.role !== 'admin');

                    html += `
                        <div class="team-member-item">
                            <div class="team-member-info">
                                <div class="member-avatar" style="background: #e2e8f0; color: #64748b;">${name.charAt(0).toUpperCase()}</div>
                                <div class="member-details">
                                    <span class="member-name">${name}</span>
                                    <span class="member-role">${m.email}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="member-status-badge" style="background: #dcfce7; color: #166534; font-weight: 700;">${roleLabel}</div>
                                ${canDelete ? `
                                    <button onclick="handleRemoveMember('${docSnap.id}', '${name}')" class="delete-member-btn" title="メンバーを削除">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6m4-11v6"/></svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                // Render Pending Invitations
                invitesSnap.forEach(docSnap => {
                    if (window.mockDeletedIds.includes(docSnap.id)) return; // Skip locally deleted
                    const iv = docSnap.data();
                    const email = docSnap.id;
                    const roleLabel = iv.role === 'admin' ? '管理者' : iv.role === 'editor' ? '編集者' : '閲覧者';

                    const canDelete = isOwner || isAdmin;

                    html += `
                        <div class="team-member-item" style="border-style: dashed; border-color: #f59e0b; background: #fffbeb;">
                            <div class="team-member-info" style="opacity: 0.8;">
                                <div class="member-avatar" style="background: #fef3c7; color: #d97706;">✉️</div>
                                <div class="member-details">
                                    <span class="member-name">招待中: ${email}</span>
                                    <span class="member-role">${roleLabel}</span>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="member-status-badge" style="background: #fef3c7; color: #b45309; font-weight: 700;">送信済み</div>
                                ${canDelete ? `
                                    <button onclick="handleCancelInvitation('${email}')" class="delete-member-btn" title="招待をキャンセル" style="color: #d97706;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                // Add Member Button (Only if slots available)
                if (currentCount < maxMembers) {
                    html += `
                        <div class="add-member-card" onclick="document.getElementById('add-member-modal').style.display='flex'">
                            <span class="add-member-text">+ チームメンバーを追加</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="limit-reached-card">
                            <p style="color: #64748b; font-weight: 600; margin: 0; font-size: 0.9rem;">
                                プランの上限（${maxMembers}名）に達しています
                            </p>
                            <a onclick="showSection('subscription')" style="color: #6366f1; font-size: 0.85rem; text-decoration: underline; cursor: pointer; display: block; margin-top: 5px;">
                                上位プランへ変更
                            </a>
                        </div>
                    `;
                }

                if (teamListEl) {
                    teamListEl.innerHTML = html;
                }

            } catch (e) {
                console.error("Team Render Error:", e);
                if (teamListEl) {
                    teamListEl.innerHTML = '<p style="color:#ef4444; text-align:center; padding:1rem;">読み込みエラーが発生しました。<br>権限設定を確認してください。</p>';
                }
            }
        }

        // --- Team Member Logic ---
        const addMemberBtn = document.getElementById('add-member-btn');
        const addMemberModal = document.getElementById('add-member-modal');
        const closeAddMemberX = document.getElementById('close-add-member-x');
        const inviteForm = document.getElementById('invite-member-form');

        if (addMemberBtn) {
            addMemberBtn.onclick = () => {
                if (addMemberModal) addMemberModal.style.display = 'flex';
            };
        }
        if (closeAddMemberX) {
            closeAddMemberX.onclick = () => {
                if (addMemberModal) addMemberModal.style.display = 'none';
            };
        }

        if (inviteForm) {
            inviteForm.onsubmit = async (e) => {
                e.preventDefault();
                const btn = inviteForm.querySelector('button[type="submit"]');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '送信中...';

                const email = document.getElementById('invite-email').value;
                const role = document.getElementById('invite-role').value;
                const user = auth.currentUser;

                try {
                    const response = await fetch('/.netlify/functions/send-invite', {
                        method: 'POST',
                        body: JSON.stringify({
                            email: email,
                            role: role,
                            senderName: currentUserData?.contact_name || currentUserData?.company_name || 'オーナー',
                            senderEmail: user.email,
                            senderUid: user.uid
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error || 'Failed to send email');

                    alert(`${email} に招待状を送信しました`);
                    if (addMemberModal) addMemberModal.style.display = 'none';
                    inviteForm.reset();
                    renderTeamSection(currentUserData); // Refresh List

                } catch (error) {
                    console.error(error);
                    alert('エラー: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            };
        }

        // --- Removal Handlers ---
        window.handleRemoveMember = async (targetUid, name) => {
            if (!confirm(`${name} さんをチームから削除しますか？\n（削除後はライトプランとして独立します）`)) return;

            await performRemoval({
                requesterUid: auth.currentUser.uid,
                targetUid: targetUid,
                type: 'member'
            });
        };

        window.handleCancelInvitation = async (email) => {
            if (!confirm(`${email} への招待をキャンセルしますか？`)) return;

            await performRemoval({
                requesterUid: auth.currentUser.uid,
                targetEmail: email,
                type: 'invitation'
            });
        };

        async function performRemoval(payload) {
            // --- MOCK FOR LOCALHOST ---
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                console.warn('MOCK: Deleting member/invite locally (server function unavailable on port 8000)');

                // Add to local ignore list (Persistent)
                const targetId = payload.targetUid || payload.targetEmail;
                if (targetId) {
                    window.mockDeletedIds.push(targetId);
                    localStorage.setItem('mockDeletedIds', JSON.stringify(window.mockDeletedIds));
                }

                await new Promise(r => setTimeout(r, 600)); // Simulate delay
                alert('【ローカル動作】削除完了しました（本番環境ではAPIが呼ばれます）');

                // Refresh UI without reload
                renderTeamSection(currentUserData);
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/remove-team-member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || '削除に失敗しました');

                alert('削除完了しました');
                renderTeamSection(currentUserData); // Refresh the list without reload
            } catch (error) {
                console.error(error);
                alert('エラー: ' + error.message);
            }
        }

        // Explicitly wait for DOM and attach listener safely
        const initLogout = () => {
            const logoutBtnSide = document.getElementById('logout-btn-side');
            console.log("Logout Button Element:", logoutBtnSide);

            if (logoutBtnSide) {
                // Remove old listeners by cloning (nuclear option) to ensure clean slate if needed, 
                // but standard onclick assignment overwrites property. using addEventListener is better.
                logoutBtnSide.onclick = async (e) => {
                    e.preventDefault();
                    console.log("Logout clicked");
                    // alert("ログアウトボタンが押されました。処理を開始します。"); // Debug Alert

                    try {
                        await signOut(auth);
                        console.log("SignOut success");
                        alert("ログアウトしました。トップページへ戻ります。");
                        window.location.href = 'index.html';
                    } catch (err) {
                        console.error("Logout Error:", err);
                        alert("ログアウトエラー: " + err.message);
                    }
                };
            } else {
                console.error("Logout button not found in DOM");
            }
        };

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initLogout);
        } else {
            initLogout();
        }

        // Date input helper
        const incDateInput = document.getElementById('incorporation-date');
        if (incDateInput) {
            incDateInput.oninput = (e) => {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 8) v = v.slice(0, 8);
                if (v.length >= 4) {
                    v = v.substring(0, 4) + (v.length > 4 ? '/' + v.substring(4, 6) : '') + (v.length > 6 ? '/' + v.substring(6, 8) : '');
                }
                e.target.value = v;
            };
        }
    </script>


    <script src="js/animations.js"></script>
</body>

</html>